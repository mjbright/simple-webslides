#!/bin/bash

VERBOSE=2

declare -a PHOTOS=(
    "static/images/city_small_dark.jpg"
    "static/images/countryside_small_dark.jpg"
    "static/images/ocean_small_dark.jpg"
    "static/images/park_small_dark.jpg"
)

declare -a BACKGROUNDS=(
    "bg-black"
    "bg-brown"
    "bg-blue"
    "bg-white"
)

process_template() {
    TEMPLATE=$1; shift
    OUTPUT=$1; shift

    [ ! -f $TEMPLATE ] && { echo "Error - no such file <$TEMPLATE>"; return 1; }

    PROCESS=0
    [ ! -f $OUTPUT ]          && { PROCESS=1; [ $VERBOSE -gt 1 ] && echo "No such file <$OUTPUT>"; }
    [ $TEMPLATE -nt $OUTPUT ] && { PROCESS=1; [ $VERBOSE -gt 1 ] && echo "$TEMPLATE newer than $OUTPUT"; }
    [ $PROCESS -ne 0 ] && [ $VERBOSE -gt 0 ] && echo "Processing $TEMPLATE --> $OUTPUT"

    if [ $PROCESS -ne 0 ]; then
        [ $VERBOSE -gt 0 ] && echo "Processing $TEMPLATE --> $OUTPUT"
	echo $__PHOTO__

	set -x
        sed -e "s/__WELCOME_MESSAGE__/$__WELCOME_MESSAGE__/g" \
            -e "s?__PHOTO__?$__PHOTO__?g" \
            -e "s/__BACKGROUND_CLASS__/$__BACKGROUND_CLASS__/g" \
            -e "s/__TEXT_INTRO__/$__TEXT_INTRO__/g" < $TEMPLATE > $OUTPUT

	set +x

        echo "---- diff $TEMPLATE $OUTPUT"
        diff $TEMPLATE $OUTPUT
    fi
}

__WELCOME_MESSAGE__="Welcome Home"
__TEXT_INTRO__="it's $(date)"

#while [ ! -z "$1" ]; do
#done


while true; do
    __TEXT_INTRO__="it's $(date)"

    IDX=$(($RANDOM % 4))
    __PHOTO__=${PHOTOS[$IDX]}
    __BACKGROUND_CLASS__=${BACKGROUNDS[$IDX]}

    #[ $VERBOSE -gt 0 ] && { echo "__PHOTO__[$IDX]=$__PHOTO__"; }

    process_template index.html.templ        index.html
    process_template index_2page.html.templ  index_2page.html

    sleep 1;
done


